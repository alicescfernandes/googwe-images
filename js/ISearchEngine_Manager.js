const app=new ISearchEngine("xml/Image_database_original.xml"),noResults="<span class='search-no-results'><p>Your search criteria didn't match any results.</p></span>";let requestingInfiniteScroll=!1;function main(){let e=document.querySelector("canvas");app.init(e),document.querySelector(".delete-on-load").remove(),window.location.hash="";let t=Array.prototype.slice.call(document.getElementsByClassName("search_input"));t.forEach((function(e){e.addEventListener("input",(function(e){document.getElementById("search_input").value=e.target.value,t.forEach((function(e){e.value=document.getElementById("search_input").value}))})),e.addEventListener("keydown",(function(e){13==e.keyCode&&document.querySelector(".search_submit").click()}))})),Array.prototype.slice.call(document.getElementsByClassName("search_submit")).forEach((function(e){e.addEventListener("click",(function(e){if(document.querySelector(".search-box-input-with-image")){var t=document.querySelector("canvas"),o=new ColorHistogram(app.redColor,app.greenColor,app.blueColor),a=new ColorMoments,r=new Event("processed_picture"),n=new Picture(0,0,0,0,document.querySelector(".search-box-input-image img").src,"",!1);return void n.computation(t,o,a,r).then(t=>{let o=app.searchISimilarity(n);window.location.hash="#/results",e.preventDefault(),document.querySelector(".search-results").innerHTML='<span class="search-load-more">\n                        <div></div>\n                        <div></div>\n                        <div></div>\n                    </span>',paintResults(o)})}let c=document.getElementById("search_input").value,s=document.getElementById("search_color").value;if(""!=c){window.location.hash="#/results";let t=app.search(c,s);e.preventDefault(),document.querySelector(".search-results").innerHTML='<span class="search-load-more">\n                <div></div>\n                <div></div>\n                <div></div>\n            </span>',paintResults(t)}}))})),Array.prototype.slice.call(document.getElementsByClassName("choose_image")).forEach((function(e){e.addEventListener("click",(function(e){document.getElementById("search_image").click()}))})),Array.prototype.slice.call(document.getElementsByClassName("search-box-input-image-close")).forEach((function(e){e.addEventListener("click",(function(e){Array.prototype.slice.call(document.getElementsByClassName("search-box-input-with-image")).forEach((function(e){e.classList.remove("search-box-input-with-image"),""==document.getElementById("search_input").value&&(window.location.hash="")}))}))}));window.addEventListener("scroll",(function(e){let t=document.body.getClientRects()[0].top,o=document.body.getClientRects()[0].height-window.innerHeight;if(Math.abs(t+o)<=400&&0==requestingInfiniteScroll){requestingInfiniteScroll=!0;let e=app.loadMore();e.length>0&&paintResults(e)}})),window.addEventListener("hashchange",(function(){"#/results"==this.window.location.hash?this.document.body.classList.add("page-results"):"#/loading"==this.window.location.hash?this.document.body.classList.add("page-loading"):(this.document.body.classList.remove("page-results"),this.document.body.classList.remove("page-loading"))}));const o=app.hexColor.map((function(e,t){return`<span data-color-idx="${t-=1}" data-color="${e}" style="background-color:${e}" class="color-search-item"></span>`})).join("");Array.prototype.slice.call(document.querySelectorAll(".color-search")).forEach((function(e){e.addEventListener("click",(function(e){e.target.classList.contains("color-search-item")&&(document.querySelector(".hide-if-results .color-search-item-selected")&&document.querySelector(".hide-if-results .color-search-item-selected").classList.remove("color-search-item-selected"),document.querySelector(".show-if-results .color-search-item-selected")&&document.querySelector(".show-if-results .color-search-item-selected").classList.remove("color-search-item-selected"),document.querySelector(`.show-if-results [data-color="${e.target.dataset.color}"]`).classList.add("color-search-item-selected"),document.querySelector(`.hide-if-results [data-color="${e.target.dataset.color}"]`).classList.add("color-search-item-selected"),document.querySelector("#search_color").value=e.target.dataset.colorIdx,"-1"===e.target.dataset.colorIdx?document.querySelector("#search_color").value="":document.querySelector("#search_color").value=e.target.dataset.colorIdx)})),e.innerHTML=o})),document.body.addEventListener("dragover",(function(e){e.preventDefault()})),document.body.addEventListener("drop",(function(e){e.preventDefault(),searchByImage(e.dataTransfer.files[0])})),document.getElementById("search_image").addEventListener("change",(function(e){searchByImage(e.target.files[0])}))}function searchByImage(e){var t=new Image;if(t.file=e,console.log(e),e.type.match("image")){const o=new FileReader;o.onload=function(e){t.src=e.target.result,Array.prototype.slice.call(document.querySelectorAll(".search-box-input")).forEach(e=>{e.classList.add("search-box-input-with-image")}),Array.prototype.slice.call(document.querySelectorAll(".search-box-input-image")).forEach(e=>{e.querySelector("img").src=t.src,e.querySelector("p").textContent=t.file.name});var o=document.querySelector("canvas"),a=new ColorHistogram(app.redColor,app.greenColor,app.blueColor),r=new ColorMoments,n=new Event("processed_picture"),c=new Picture(0,0,0,0,t.src,"",!1);c.computation(o,a,r,n).then(t=>{let o=app.searchISimilarity(c);window.location.hash="#/results",e.preventDefault(),document.querySelector(".search-results").innerHTML='<span class="search-load-more">\n                <div></div>\n                <div></div>\n                <div></div>\n            </span>',paintResults(o)})},o.readAsDataURL(e)}else console.log("this is not an image")}function toggledDarkMode(){"dark"==document.querySelector("body").dataset.mode?document.querySelector("body").dataset.mode="light":(document.querySelector("body").dataset.mode="dark",console.log("U2ltIExlbywgaXN0byBz428gbWFyaXF1aWNlcyE="))}function paintResults(e){e.forEach(e=>{let t=`<div class="search-result">\n                        \n                            <div class="search-result-image" style="background-image: url(${e.impath});"></div>\n                            <div class="search-result-meta">\n                                <p>${e.title}</p>\n                                <span class="search-result-meta-color" style="background-color: ${e.dominantColor};"></span>\n                                <span class="search-result-meta-width">\n                                    ${e.imgobj.width} &#10005 ${e.imgobj.height} pixels\n                                </span>\n                            </div>\n                        </div>`;document.querySelector(".search-load-more").insertAdjacentHTML("beforebegin",t)}),0==e.length&&document.querySelector(".search-load-more").insertAdjacentHTML("beforebegin",noResults),e.length<app.itemsPerPage&&this.document.querySelector(".search-load-more").remove(),requestingInfiniteScroll=!1}function Generate_Image(e){for(var t=e.getContext("2d"),o=t.createImageData(100,100),a=0;a<o.data.length;a+=4)o.data[a+0]=204,o.data[a+1]=0,o.data[a+2]=0,o.data[a+3]=255,(a>=8e3&&a<8400||a>=16e3&&a<16400||a>=24e3&&a<24400||a>=32e3&&a<32400)&&(o.data[a+1]=200);return t.putImageData(o,150,0),o}