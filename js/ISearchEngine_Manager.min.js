const app=new ISearchEngine("xml/database_parsed.xml",!0),noResults="<span class='search-no-results'><p>Your search criteria didn't match any results.</p></span>";let requestingInfiniteScroll=!1;function main(){let e=document.querySelector("canvas");app.init(e),document.querySelector(".delete-on-load").remove(),window.location.hash="";let t=Array.prototype.slice.call(document.getElementsByClassName("search_input"));t.forEach((function(e){e.addEventListener("input",(function(e){document.getElementById("search_input").value=e.target.value,t.forEach((function(e){e.value=document.getElementById("search_input").value}))})),e.addEventListener("keydown",(function(e){13==e.keyCode&&document.querySelector(".search_submit").click()}))})),Array.prototype.slice.call(document.getElementsByClassName("search_submit")).forEach((function(e){e.addEventListener("click",(function(e){if(document.querySelector(".search-box-input-with-image")){var t=document.querySelector("canvas"),a=new ColorHistogram(app.redColor,app.greenColor,app.blueColor),o=new ColorMoments,n=new Event("processed_picture"),r=new Picture(0,0,0,0,document.querySelector(".search-box-input-image img").src,"",!1);return void r.computation(t,a,o,n).then(t=>{let a=app.searchISimilarity(r);e.preventDefault(),document.querySelector(".search-results").innerHTML='<span class="search-load-more">\n                        <div></div>\n                        <div></div>\n                        <div></div>\n                    </span>',paintResults(a)})}let c=document.getElementById("search_input").value,s=document.getElementById("search_color").value;if(""!=c){window.location.hash="#/results";let t=app.search(c,s);e.preventDefault(),document.querySelector(".search-results").innerHTML='<span class="search-load-more">\n                <div></div>\n                <div></div>\n                <div></div>\n            </span>',paintResults(t)}}))})),Array.prototype.slice.call(document.getElementsByClassName("choose_image")).forEach((function(e){e.addEventListener("click",(function(e){document.getElementById("search_image").click()}))})),Array.prototype.slice.call(document.getElementsByClassName("search-box-input-image-close")).forEach((function(e){e.addEventListener("click",(function(e){Array.prototype.slice.call(document.getElementsByClassName("search-box-input-with-image")).forEach((function(e){e.classList.remove("search-box-input-with-image"),""==document.getElementById("search_input").value&&(window.location.hash="")}))}))}));window.addEventListener("scroll",(function(e){let t=document.body.getClientRects()[0].top,a=document.body.getClientRects()[0].height-window.innerHeight;if(Math.abs(t+a)<=400&&0==requestingInfiniteScroll){requestingInfiniteScroll=!0;let e=app.loadMore();e.length>0&&paintResults(e)}})),window.addEventListener("hashchange",(function(){"#/results"==this.window.location.hash?this.document.body.classList.add("page-results"):"#/loading"==this.window.location.hash?this.document.body.classList.add("page-loading"):(this.document.body.classList.remove("page-results"),this.document.body.classList.remove("page-loading"))}));const a=app.hexColor.map((function(e,t){return`<span data-color-idx="${t-=1}" data-color="${e}" style="background-color:${e}" class="color-search-item"></span>`})).join("");Array.prototype.slice.call(document.querySelectorAll(".color-search")).forEach((function(e){e.addEventListener("click",(function(e){e.target.classList.contains("color-search-item")&&(document.querySelector(".hide-if-results .color-search-item-selected")&&document.querySelector(".hide-if-results .color-search-item-selected").classList.remove("color-search-item-selected"),document.querySelector(".show-if-results .color-search-item-selected")&&document.querySelector(".show-if-results .color-search-item-selected").classList.remove("color-search-item-selected"),document.querySelector(`.show-if-results [data-color="${e.target.dataset.color}"]`).classList.add("color-search-item-selected"),document.querySelector(`.hide-if-results [data-color="${e.target.dataset.color}"]`).classList.add("color-search-item-selected"),document.querySelector("#search_color").value=e.target.dataset.colorIdx,"-1"===e.target.dataset.colorIdx?document.querySelector("#search_color").value="":document.querySelector("#search_color").value=e.target.dataset.colorIdx)})),e.innerHTML=a})),document.body.addEventListener("dragover",(function(e){e.preventDefault()})),document.body.addEventListener("drop",(function(e){e.preventDefault(),searchByImage(e.dataTransfer.files[0])})),document.getElementById("search_image").addEventListener("change",(function(e){searchByImage(e.target.files[0])}))}function searchByImage(e){document.querySelector(".page-search .loading-animation").style.display="flex";var t=new Image;if(t.file=e,console.log(e),e.type.match("image")){const a=new FileReader;a.onload=function(e){t.src=e.target.result,Array.prototype.slice.call(document.querySelectorAll(".search-box-input")).forEach(e=>{e.classList.add("search-box-input-with-image")}),Array.prototype.slice.call(document.querySelectorAll(".search-box-input-image")).forEach(e=>{e.querySelector("img").src=t.src,e.querySelector("p").textContent=t.file.name});var a=document.querySelector("canvas"),o=new ColorHistogram(app.redColor,app.greenColor,app.blueColor),n=new ColorMoments,r=new Event("processed_picture"),c=new Picture(0,0,0,0,t.src,"",!1);c.computation(a,o,n,r).then(e=>{let t=app.searchISimilarity(c);document.querySelector(".search-results").innerHTML='<span class="search-load-more">\n                <div></div>\n                <div></div>\n                <div></div>\n                </span>',paintResults(t),document.querySelector(".page-search .loading-animation").style.display="none",window.location.hash="#/results"})},a.readAsDataURL(e)}else console.log("this is not an image")}function toggledDarkMode(){"dark"==document.querySelector("body").dataset.mode?document.querySelector("body").dataset.mode="light":(document.querySelector("body").dataset.mode="dark",console.log("U2ltIExlbywgaXN0byBz428gbWFyaXF1aWNlcyE="))}function onImageLoaded(e){let t=0;e.target.getClientRects().length>0&&(t=-1*(e.target.getClientRects()[0].height-220)/2||0),e.target.style.marginTop=t+"px",e.target.classList.add("image-loaded"),e.target.style.animationDelay=50*e.target.dataset.idx+"ms"}function paintResults(e){window.location.hash="#/results",e.forEach((e,t)=>{let a=`<div class="search-result">\n                            <div class="search-result-image" style="background-color:${e.dominantColor};">\n                                <img data-idx="${t}"onload="onImageLoaded(event)"class="search-result-image-content" src="${e.impath}"></img>\n                            </div>\n                            <div class="search-result-meta">\n                                <p>${e.title}</p>\n                                <span class="search-result-meta-color" style="background-color: ${e.dominantColor};"></span>\n                                <span class="search-result-meta-width">\n                                    ${e.imgobj.width} &#10005 ${e.imgobj.height} pixels\n                                </span>\n                            </div>\n                        </div>`;document.querySelector(".search-load-more").insertAdjacentHTML("beforebegin",a)}),0==e.length&&document.querySelector(".search-load-more").insertAdjacentHTML("beforebegin",noResults),e.length<app.itemsPerPage&&this.document.querySelector(".search-load-more").remove(),requestingInfiniteScroll=!1}function Generate_Image(e){for(var t=e.getContext("2d"),a=t.createImageData(100,100),o=0;o<a.data.length;o+=4)a.data[o+0]=204,a.data[o+1]=0,a.data[o+2]=0,a.data[o+3]=255,(o>=8e3&&o<8400||o>=16e3&&o<16400||o>=24e3&&o<24400||o>=32e3&&o<32400)&&(a.data[o+1]=200);return t.putImageData(a,150,0),a}